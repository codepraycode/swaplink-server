# SwapLink Server - Staging Deployment Guide

## üéØ Overview

This guide explains how to deploy SwapLink to Render in **staging mode** - a configuration that uses production infrastructure (Render, Resend) but doesn't require Globus Bank credentials yet.

### What is Staging Mode?

Staging mode allows you to:

-   ‚úÖ Deploy to Render with production infrastructure
-   ‚úÖ Use Resend for real email delivery
-   ‚úÖ Test all features except actual payment processing
-   ‚úÖ Use mock services for Globus Bank API
-   ‚ùå **Cannot** process real payments (Globus Bank integration disabled)

This is perfect for:

-   Testing the deployment process
-   Verifying email service integration
-   Developing and testing features before getting Globus credentials
-   Demo and preview environments

## üöÄ Quick Deploy to Staging

### Step 1: Push to GitHub

```bash
git add .
git commit -m "Deploy to Render staging"
git push origin main
```

### Step 2: Deploy on Render

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click "New" ‚Üí "Blueprint"
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml` and deploy all services

### Step 3: Configure Required Secrets

You only need to configure these environment variables in Render:

#### Essential (Required)

-   `RESEND_API_KEY` - Get from [resend.com/api-keys](https://resend.com/api-keys)

#### Optional (For file uploads)

-   `AWS_ACCESS_KEY_ID` - Your AWS/R2 access key
-   `AWS_SECRET_ACCESS_KEY` - Your AWS/R2 secret key
-   `AWS_ENDPOINT` - Your S3/R2 endpoint

#### Not Required in Staging

-   ~~`GLOBUS_SECRET_KEY`~~ - Not needed (mocked)
-   ~~`GLOBUS_WEBHOOK_SECRET`~~ - Not needed (mocked)
-   ~~`GLOBUS_BASE_URL`~~ - Not needed (mocked)
-   ~~`GLOBUS_CLIENT_ID`~~ - Not needed (mocked)

Everything else is auto-configured!

## üìß Resend Setup (Required)

### 1. Create Resend Account

-   Sign up at [resend.com](https://resend.com)
-   Verify your email address

### 2. Verify Your Domain

1. Go to **Domains** in Resend dashboard
2. Click "Add Domain"
3. Enter your domain (e.g., `swaplink.com`)
4. Add these DNS records to your domain:

```
Type: TXT
Name: @
Value: v=spf1 include:_spf.resend.com ~all

Type: TXT
Name: resend._domainkey
Value: [Provided by Resend - DKIM key]

Type: TXT
Name: _dmarc
Value: v=DMARC1; p=none
```

5. Wait for verification (usually 5-10 minutes)

### 3. Generate API Key

1. Go to **API Keys** in Resend dashboard
2. Click "Create API Key"
3. Name: "SwapLink Staging"
4. Permissions: "Sending access"
5. Copy the API key (starts with `re_`)
6. Add to Render as `RESEND_API_KEY`

### 4. Update FROM_EMAIL

In Render dashboard, update the `FROM_EMAIL` environment variable:

```
FROM_EMAIL=onboarding@yourdomain.com
```

**Important:** Must use your verified domain!

## üîç Verify Deployment

### 1. Check Services

All services should show "Live" in Render dashboard:

-   ‚úÖ `swaplink-api-staging` (Web Service)
-   ‚úÖ `swaplink-worker-staging` (Worker)
-   ‚úÖ `swaplink-db-staging` (PostgreSQL)
-   ‚úÖ `swaplink-redis-staging` (Redis)

### 2. Test Health Endpoint

```bash
curl https://swaplink-api-staging.onrender.com/api/v1/health
```

Expected response:

```json
{
    "status": "ok",
    "timestamp": "2025-12-17T14:30:00.000Z",
    "environment": "production"
}
```

### 3. Check Logs

API service logs should show:

```
‚úÖ Using Resend Email Service for production
‚ÑπÔ∏è Running in STAGING mode - Globus Bank API mocked
```

### 4. Test Email Service

1. Register a new user via API
2. Check Resend dashboard for email delivery
3. Verify OTP email received

## üóÑÔ∏è Database Migration

After first deployment, run migrations:

### Option 1: Using Render Shell

1. Go to your API service in Render dashboard
2. Click "Shell" tab
3. Run:
    ```bash
    pnpm db:deploy
    ```

### Option 2: Using Local Connection

1. Get the **External Database URL** from PostgreSQL service
2. Run locally:
    ```bash
    DATABASE_URL="your_external_database_url" pnpm db:deploy
    ```

## ‚öôÔ∏è Environment Configuration

### Auto-Configured by render.yaml

```bash
NODE_ENV=production
STAGING=true                    # Enables staging mode
PORT=3000
ENABLE_FILE_LOGGING=false
FROM_EMAIL=onboarding@swaplink.com
FRONTEND_URL=https://swaplink.app
CORS_URLS=https://swaplink.app,https://app.swaplink.com
SYSTEM_USER_ID=system-wallet-user
```

### Auto-Configured by Render

```bash
DATABASE_URL=<from PostgreSQL service>
REDIS_URL=<from Redis service>
SERVER_URL=<from web service>
JWT_SECRET=<auto-generated>
JWT_REFRESH_SECRET=<auto-generated>
```

### You Must Configure

```bash
RESEND_API_KEY=re_your_api_key_here
```

### Optional (for file uploads)

```bash
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_ENDPOINT=https://account-id.r2.cloudflarestorage.com
```

## üß™ Testing in Staging

### What Works

-   ‚úÖ User registration and authentication
-   ‚úÖ Email verification (via Resend)
-   ‚úÖ Phone verification (OTP via email)
-   ‚úÖ Wallet creation
-   ‚úÖ Internal transfers (between users)
-   ‚úÖ P2P ad creation and browsing
-   ‚úÖ P2P order flow
-   ‚úÖ Chat functionality
-   ‚úÖ Admin features
-   ‚úÖ File uploads (if AWS/R2 configured)

### What Doesn't Work (Mocked)

-   ‚ùå Virtual account funding (Globus Bank)
-   ‚ùå External bank withdrawals (Globus Bank)
-   ‚ùå Real payment processing (Globus Bank)
-   ‚ùå Webhook callbacks from Globus Bank

### Mock Behavior

When Globus Bank APIs are called in staging mode:

-   Requests are logged but not sent
-   Mock responses are returned
-   No actual money movement occurs
-   Useful for testing UI/UX flows

## üîÑ Upgrading to Production

When you're ready to enable real payments:

### 1. Get Globus Credentials

Obtain from Globus Bank:

-   `GLOBUS_SECRET_KEY`
-   `GLOBUS_WEBHOOK_SECRET`
-   `GLOBUS_BASE_URL`
-   `GLOBUS_CLIENT_ID`

### 2. Update Environment Variables

In Render dashboard:

1. Set `STAGING` to `"false"` (or remove it)
2. Add all Globus credentials

### 3. Redeploy

Services will automatically redeploy with new configuration.

### 4. Verify

Check logs for:

```
‚úÖ Globus Bank API initialized
‚úÖ Using Resend Email Service for production
```

## üêõ Troubleshooting

### Issue: Emails Not Sending

**Solution:**

1. Verify `RESEND_API_KEY` is set correctly
2. Check domain is verified in Resend dashboard
3. Ensure `FROM_EMAIL` uses verified domain
4. Check Resend dashboard for delivery logs

### Issue: Service Won't Start

**Solution:**

1. Check build logs in Render
2. Verify `DATABASE_URL` is set
3. Verify `REDIS_URL` is set
4. Check for missing required environment variables

### Issue: Database Connection Failed

**Solution:**

1. Ensure PostgreSQL service is running
2. Check database and API are in same region
3. Verify `DATABASE_URL` format is correct

### Issue: "Missing Globus credentials" Error

**Solution:**

1. Verify `STAGING=true` is set in environment variables
2. Check logs for staging mode confirmation
3. Redeploy if needed

## üìä Monitoring

### Render Dashboard

Monitor:

-   Service health and uptime
-   CPU and memory usage
-   Request metrics
-   Error logs

### Resend Dashboard

Monitor:

-   Email delivery status
-   Bounce and complaint rates
-   API usage

### Application Logs

Watch for:

-   Email sending confirmations
-   Staging mode indicators
-   Mock service usage
-   Any errors or warnings

## üí∞ Cost (Free Tier)

All services run on Render's free tier:

-   Web Service: Free (750 hours/month)
-   Worker: Free (750 hours/month)
-   PostgreSQL: Free (Starter plan)
-   Redis: Free (Starter plan)

**Total: $0/month**

**Note:** Free tier services may spin down after inactivity.

## üéØ Next Steps

After successful staging deployment:

1. ‚úÖ Test all features thoroughly
2. ‚úÖ Verify email delivery works
3. ‚úÖ Test user flows end-to-end
4. ‚úÖ Monitor logs for errors
5. ‚úÖ When ready, obtain Globus credentials
6. ‚úÖ Upgrade to production mode

## üìö Related Documentation

-   [Full Deployment Guide](./RENDER_DEPLOYMENT.md) - Complete production deployment
-   [Environment Variables](./ENV_VARIABLES.md) - All environment variables explained
-   [Deployment Checklist](./DEPLOYMENT_CHECKLIST.md) - Step-by-step checklist

## üÜò Support

Need help?

-   Check [RENDER_DEPLOYMENT.md](./RENDER_DEPLOYMENT.md) troubleshooting section
-   Review Render service logs
-   Check Resend dashboard for email issues
-   Verify all environment variables are set correctly

---

**Ready to deploy?** Follow the steps above and you'll have a working staging environment in minutes! üöÄ

When you're ready for production with real payments, just add your Globus credentials and set `STAGING=false`.
