
generator client {
  provider = "prisma-client-js"
  output   = "../src/database/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  phone            String    @unique
  password         String
  firstName        String
  lastName         String
  
  // KYC & Status
  kycLevel         KycLevel  @default(NONE)
  kycStatus        KycStatus @default(PENDING)
  isVerified       Boolean   @default(false)
  isActive         Boolean   @default(true)
  twoFactorEnabled Boolean   @default(false)
  
  // Metadata
  lastLogin        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Security
  transactionPin   String?
  pinAttempts      Int       @default(0)
  pinLockedUntil   DateTime?

  // Relations
  wallet           Wallet?   // 1:1 Relation (One user, one wallet)
  bankAccounts     BankAccount[]
  kycDocuments     KycDocument[]
  transactions     Transaction[] // History of transactions initiated by user
  beneficiaries    Beneficiary[]

  @@map("users")
}

// ==========================================
// WALLET SYSTEM (Strictly NGN)
// ==========================================

model Wallet {
  id            String   @id @default(uuid())
  userId        String   @unique // Enforces 1-to-1 relationship
  
  // Balances (Implicitly NGN)
  balance       Float    @default(0)
  lockedBalance Float    @default(0) // For pending withdrawals or frozen funds
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  virtualAccount VirtualAccount?

  @@map("wallets")
}

model VirtualAccount {
  id            String   @id @default(uuid())
  walletId      String   @unique
  accountNumber String   @unique
  accountName   String
  bankName      String   @default("Globus Bank")
  provider      String   @default("GLOBUS")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("virtual_accounts")
}

model Transaction {
  id             String            @id @default(uuid())
  userId         String
  walletId       String
  
  // Details
  type           TransactionType
  amount         Float
  balanceBefore  Float
  balanceAfter   Float
  status         TransactionStatus @default(PENDING)
  reference      String            @unique
  description    String?           // E.g., "Transfer to John Doe"
  metadata       Json?             // Store external gateway refs (Paystack/Flutterwave)

  // Banking Fields
  destinationBankCode String?
  destinationAccount  String?
  destinationName     String?
  sessionId           String?  // NIBSS Session ID from Globus
  fee                 Float    @default(0)
  
  // Idempotency
  idempotencyKey      String?  @unique
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  wallet Wallet @relation(fields: [walletId], references: [id])

  @@map("transactions")
}

model Beneficiary {
  id            String   @id @default(uuid())
  userId        String
  accountNumber String
  accountName   String
  bankCode      String
  bankName      String
  isInternal    Boolean  @default(false)
  avatarUrl     String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, accountNumber, bankCode])
  @@map("beneficiaries")
}

// ==========================================
// BANKING & COMPLIANCE
// ==========================================

model BankAccount {
  id            String   @id @default(uuid())
  userId        String
  
  // Bank Details
  accountNumber String
  accountName   String
  bankName      String
  bankCode      String   // CBN Bank Code
  
  isVerified    Boolean  @default(false)
  isPrimary     Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bank_accounts")
}

model KycDocument {
  id              String            @id @default(uuid())
  userId          String
  
  documentType    String            // NIN, BVN_SLIP, PASSPORT
  documentUrl     String            // Cloudinary/S3 URL
  status          KycDocumentStatus @default(PENDING)
  rejectionReason String?
  verifiedAt      DateTime?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

// ==========================================
// SECURITY (OTP)
// ==========================================

model Otp {
  id         String   @id @default(uuid())
  identifier String   // email or phone
  code       String
  type       OtpType
  expiresAt  DateTime
  isUsed     Boolean  @default(false)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("otps")
}

// ==========================================
// ENUMS
// ==========================================

enum KycLevel {
  NONE
  BASIC         // Email/Phone Verified
  INTERMEDIATE  // BVN/NIN Verified
  FULL          // Utility Bill/Gov ID Verified
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum KycDocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransactionType {
  DEPOSIT       // Funding via Bank/Card
  WITHDRAWAL    // Payout to Bank
  TRANSFER      // Internal P2P (User to User)
  BILL_PAYMENT  // Airtime/Data/Utilities
  FEE           // Service charges
  REVERSAL      // System corrections
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum OtpType {
  PHONE_VERIFICATION
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR
  WITHDRAWAL_CONFIRMATION
}