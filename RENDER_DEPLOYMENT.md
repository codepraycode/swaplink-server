# SwapLink Server - Render Deployment Guide (Staging)

This guide walks you through deploying the SwapLink server to Render for staging environment with Resend email service integration.

## üìã Prerequisites

Before deploying, ensure you have:

1. **Render Account**: Sign up at [render.com](https://render.com)
2. **Resend Account**: Sign up at [resend.com](https://resend.com) and verify your domain
3. **GitHub Repository**: Your code should be pushed to a GitHub repository
4. **External Services**:
    - Globus Bank API credentials (for payment processing)
    - AWS S3 or Cloudflare R2 credentials (for file storage)

## üöÄ Quick Deploy

### Option 1: Deploy with Blueprint (Recommended)

1. **Push your code to GitHub** (if not already done)

    ```bash
    git add .
    git commit -m "Prepare for Render deployment"
    git push origin main
    ```

2. **Deploy to Render**

    - Go to [Render Dashboard](https://dashboard.render.com)
    - Click "New" ‚Üí "Blueprint"
    - Connect your GitHub repository
    - Select the repository containing `render.yaml`
    - Render will automatically detect and deploy all services

3. **Configure Environment Variables**

    After deployment, you need to set the following secret environment variables in the Render dashboard:

    **For API Service (`swaplink-api-staging`):**

    - `RESEND_API_KEY`: Your Resend API key from https://resend.com/api-keys
    - `GLOBUS_SECRET_KEY`: Your Globus Bank secret key
    - `GLOBUS_WEBHOOK_SECRET`: Your Globus webhook secret
    - `GLOBUS_BASE_URL`: Globus API base URL
    - `GLOBUS_CLIENT_ID`: Your Globus client ID
    - `AWS_ACCESS_KEY_ID`: Your AWS/R2 access key
    - `AWS_SECRET_ACCESS_KEY`: Your AWS/R2 secret key
    - `AWS_ENDPOINT`: Your S3/R2 endpoint URL

    **For Worker Service (`swaplink-worker-staging`):**

    - Same as above (Render will sync these automatically if configured)

### Option 2: Manual Deployment

If you prefer to deploy manually without the blueprint:

#### 1. Create PostgreSQL Database

1. Go to Render Dashboard ‚Üí "New" ‚Üí "PostgreSQL"
2. Configure:
    - Name: `swaplink-db-staging`
    - Database: `swaplink_staging`
    - Region: `Oregon` (or your preferred region)
    - Plan: `Starter` (free tier)
3. Click "Create Database"
4. Copy the **Internal Database URL** for later use

#### 2. Create Redis Instance

1. Go to Render Dashboard ‚Üí "New" ‚Üí "Redis"
2. Configure:
    - Name: `swaplink-redis-staging`
    - Region: `Oregon` (same as database)
    - Plan: `Starter` (free tier)
    - Max Memory Policy: `allkeys-lru`
3. Click "Create Redis"
4. Copy the **Internal Redis URL** for later use

#### 3. Deploy API Server

1. Go to Render Dashboard ‚Üí "New" ‚Üí "Web Service"
2. Connect your GitHub repository
3. Configure:

    - **Name**: `swaplink-api-staging`
    - **Environment**: `Docker`
    - **Region**: `Oregon`
    - **Branch**: `main`
    - **Dockerfile Path**: `./Dockerfile`
    - **Docker Command**: `node dist/api/server.js`
    - **Plan**: `Starter`
    - **Health Check Path**: `/api/v1/health`

4. **Environment Variables**: Add all variables from the `.env.example` file (see section below)

5. Click "Create Web Service"

#### 4. Deploy Background Worker

1. Go to Render Dashboard ‚Üí "New" ‚Üí "Background Worker"
2. Connect your GitHub repository
3. Configure:

    - **Name**: `swaplink-worker-staging`
    - **Environment**: `Docker`
    - **Region**: `Oregon`
    - **Branch**: `main`
    - **Dockerfile Path**: `./Dockerfile`
    - **Docker Command**: `node dist/worker/index.js`
    - **Plan**: `Starter`

4. **Environment Variables**: Add the same variables as the API server

5. Click "Create Background Worker"

## üîê Environment Variables Configuration

### Required Variables (Must be set manually)

```bash
# Resend Email Service
RESEND_API_KEY=re_your_actual_api_key_here

# Globus Bank API
GLOBUS_SECRET_KEY=your_globus_secret_key
GLOBUS_WEBHOOK_SECRET=your_globus_webhook_secret
GLOBUS_BASE_URL=https://api.globusbank.com
GLOBUS_CLIENT_ID=your_globus_client_id

# AWS/Cloudflare R2 Storage
AWS_ACCESS_KEY_ID=your_access_key_id
AWS_SECRET_ACCESS_KEY=your_secret_access_key
AWS_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com
```

### Auto-configured Variables (Set by Render)

```bash
DATABASE_URL=<from PostgreSQL service>
REDIS_URL=<from Redis service>
SERVER_URL=<from web service URL>
JWT_SECRET=<auto-generated>
JWT_REFRESH_SECRET=<auto-generated>
```

### Standard Variables (Pre-configured in render.yaml)

```bash
NODE_ENV=production
PORT=3000
ENABLE_FILE_LOGGING=false
CORS_URLS=https://swaplink.app,https://app.swaplink.com
FROM_EMAIL=onboarding@swaplink.com
FRONTEND_URL=https://swaplink.app
SYSTEM_USER_ID=system-wallet-user
```

## üìß Resend Email Service Setup

### 1. Create Resend Account

1. Go to [resend.com](https://resend.com) and sign up
2. Verify your email address

### 2. Add and Verify Domain

1. Go to **Domains** in Resend dashboard
2. Click "Add Domain"
3. Enter your domain (e.g., `swaplink.com`)
4. Add the provided DNS records to your domain:
    - **SPF Record**: `v=spf1 include:_spf.resend.com ~all`
    - **DKIM Record**: Provided by Resend
    - **DMARC Record**: `v=DMARC1; p=none`
5. Wait for verification (usually takes a few minutes)

### 3. Generate API Key

1. Go to **API Keys** in Resend dashboard
2. Click "Create API Key"
3. Name it (e.g., "SwapLink Staging")
4. Select permissions: "Sending access"
5. Copy the API key (starts with `re_`)
6. Add it to Render environment variables as `RESEND_API_KEY`

### 4. Configure FROM_EMAIL

Update the `FROM_EMAIL` environment variable in Render to use your verified domain:

```bash
FROM_EMAIL=onboarding@yourdomain.com
# or
FROM_EMAIL=no-reply@yourdomain.com
```

**Note**: The email address must use your verified domain.

## üóÑÔ∏è Database Migration

After deploying, you need to run database migrations:

### Option 1: Using Render Shell

1. Go to your API service in Render dashboard
2. Click "Shell" tab
3. Run migrations:
    ```bash
    pnpm db:deploy
    ```

### Option 2: Using Local Connection

1. Get the **External Database URL** from your PostgreSQL service
2. Run locally:
    ```bash
    DATABASE_URL="your_external_database_url" pnpm db:deploy
    ```

### Seed Database (Optional)

To seed the database with initial data:

```bash
DATABASE_URL="your_database_url" pnpm db:seed
```

## üîç Verify Deployment

### 1. Check Service Health

Visit your API health endpoint:

```
https://swaplink-api-staging.onrender.com/api/v1/health
```

Expected response:

```json
{
    "status": "ok",
    "timestamp": "2025-12-17T14:30:00.000Z",
    "environment": "production"
}
```

### 2. Check Logs

Monitor logs in Render dashboard:

-   API Service logs should show: `‚úÖ Using Resend Email Service for production`
-   Worker logs should show successful job processing

### 3. Test Email Sending

Test the email service by:

1. Registering a new user
2. Requesting password reset
3. Check Resend dashboard for email delivery status

## üîÑ Continuous Deployment

Render automatically deploys when you push to your main branch:

```bash
git add .
git commit -m "Your changes"
git push origin main
```

To disable auto-deploy:

1. Go to service settings in Render
2. Uncheck "Auto-Deploy"

## üìä Monitoring

### Render Dashboard

Monitor your services in the Render dashboard:

-   **Metrics**: CPU, Memory, Request count
-   **Logs**: Real-time application logs
-   **Events**: Deployment history

### Resend Dashboard

Monitor email delivery:

-   **Emails**: View sent emails and delivery status
-   **Analytics**: Email open rates, click rates
-   **Logs**: Detailed email delivery logs

## üêõ Troubleshooting

### Issue: Build Fails

**Solution**: Check build logs and ensure all dependencies are in `package.json`

```bash
# Locally test the build
pnpm install --frozen-lockfile
pnpm db:generate
pnpm build
```

### Issue: Database Connection Fails

**Solution**:

1. Verify `DATABASE_URL` is set correctly
2. Check database service is running
3. Ensure database and API are in the same region

### Issue: Emails Not Sending

**Solution**:

1. Verify `RESEND_API_KEY` is set correctly
2. Check domain is verified in Resend
3. Ensure `FROM_EMAIL` uses verified domain
4. Check Resend dashboard for error logs

### Issue: Worker Not Processing Jobs

**Solution**:

1. Verify Redis connection
2. Check worker logs for errors
3. Ensure `REDIS_URL` matches between API and Worker

### Issue: CORS Errors

**Solution**: Update `CORS_URLS` to include your frontend domain:

```bash
CORS_URLS=https://yourdomain.com,https://app.yourdomain.com
```

## üîí Security Best Practices

1. **Rotate Secrets Regularly**: Update API keys and secrets periodically
2. **Use Environment Variables**: Never commit secrets to git
3. **Enable HTTPS**: Render provides free SSL certificates
4. **Monitor Logs**: Regularly check for suspicious activity
5. **Limit CORS**: Only allow trusted domains
6. **Rate Limiting**: Already configured in the application

## üí∞ Cost Estimation (Render Free Tier)

-   **PostgreSQL**: Free (Starter plan)
-   **Redis**: Free (Starter plan)
-   **Web Service**: Free (750 hours/month)
-   **Background Worker**: Free (750 hours/month)

**Note**: Free tier services may spin down after inactivity. Consider upgrading to paid plans for production.

## üìö Additional Resources

-   [Render Documentation](https://render.com/docs)
-   [Resend Documentation](https://resend.com/docs)
-   [Prisma Deployment Guide](https://www.prisma.io/docs/guides/deployment)
-   [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)

## üÜò Support

If you encounter issues:

1. Check the [Render Status Page](https://status.render.com)
2. Review [Resend Status](https://status.resend.com)
3. Contact support:
    - Render: support@render.com
    - Resend: support@resend.com

## üéâ Next Steps

After successful deployment:

1. ‚úÖ Configure custom domain
2. ‚úÖ Set up monitoring and alerts
3. ‚úÖ Configure backup strategy
4. ‚úÖ Set up staging ‚Üí production promotion workflow
5. ‚úÖ Document API endpoints for frontend team

---

**Deployed Successfully?** üöÄ Great! Your SwapLink server is now running in the cloud with production-ready email service!
